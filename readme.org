#+property: header-args:emacs-lisp :tangle "readme.el" :lexical t
#+startup: content indent

This repository is iwachan's emacs setting.
I use to NT version emacs for windows.
Windows 10 or Windows 11.
We delay loading as much as possible.

* My init el configure
** header
#+begin_src emacs-lisp
  ;; -*- lexical-binding: t -*-
  ;; profile
  ;;(require 'profiler)
  ;;(profiler-start 'cpu)
#+end_src

** Kind of OS determine
#+begin_src emacs-lisp
  (defconst IS-MAC (eq system-type 'darwin))
  (defconst IS-LINUX (memq system-type '(gnu gnu/linux gnu/kfreebsd berkeley-unix)))
  (defconst IS-WINDOWS (memq system-type '(cygwin windows-nt ms-dos)))
#+end_src

** GC
early-init.elで設定した内容を元に戻します
#+begin_src emacs-lisp
  (add-hook 'focus-out-hook #'garbage-collect)
  ;; 常時ログ出力は負荷が掛かるので行わない
  (setq garbage-collection-messages nil)

  (add-hook 'emacs-startup-hook
            (lambda ()
              ;; 起動後にGC設定は戻す方が良いとGPTが言う
              (setq gc-cons-percentage 0.1)
              (setq gc-cons-threshold (* 64 1024 1024))

  	    ;; early-initで退避した値を復元する
  	    (when (boundp 'startup/file-name-handler-alist)
  	      (setq file-name-handler-alist startup/file-name-handler-alist))))
#+end_src
** Disable Scroll Bar in minibuffer window
#+begin_src emacs-lisp
  (add-hook 'after-make-frame-functions
            (lambda (frame)
              (let ((w (minibuffer-window frame)))
                (when (window-live-p w)
  		(set-window-scroll-bars w 0 nil 0 nil t)
  		(set-window-fringes w 0 0 nil t)))))
#+end_src

** config of ff-find-other-file
#+begin_src emacs-lisp
  ;; Associate extensions to be used with ff-find-other-file
  (setq cc-other-file-alist
        '(
    	("\\.c"   (".h" ".hpp"))
    	("\\.cpp"   (".h" ".hpp"))
    	("\\.h"   (".c" ".cpp"))
    	("\\.hpp"   (".c" ".cpp"))))

  ;; Set target directories to look for with ff-find-other-files
  (setq ff-search-directories
        '("." "../src" "../include" "../main" "../core" "../*"))

  ;; Set ff-find-other-file to work with Meta+t
  (global-set-key "\M-t" 'ff-find-other-file)
#+end_src
** environment to Japanese, UTF-8
#+begin_src emacs-lisp
  (setenv "LANG" "ja_JP.UTF-8")
  (prefer-coding-system 'utf-8-unix)
  (set-file-name-coding-system 'cp932)
  (setq locale-coding-system 'utf-8-unix)
  ;; Determine the DECODING setting of process-coding-system by determining the character encoding output by the process.
  (when IS-WINDOWS
    (setq-default default-process-coding-system '(utf-8-unix . japanese-cp932-dos)))
#+end_src
** 曜日/日付フォーマットは英語表示にしたい
org-scheduleなどで有効
>= emacs 28
#+begin_src emacs-lisp
  (setq system-time-locale "C")
#+end_src

** emacs実行環境パスを追加
#+begin_src emacs-lisp
  ;; MSYS2(UCRT64) bin を見つけたら PATH/exec-path に追加（公式Windows EmacsでもMSYS2 Emacsでも共通化）
  (defun my--first-existing-dir (&rest dirs)
    (seq-find (lambda (d) (and (stringp d) (file-directory-p d))) dirs))

  (let* ((msys2-root
          (my--first-existing-dir
           "C:/msys64"
           "C:/software/msys2"
           "C:/software/msys2_64"))
         (ucrt-bin (and msys2-root (expand-file-name "ucrt64/bin" msys2-root))))
    (when (and (eq system-type 'windows-nt)
               ucrt-bin
               (file-directory-p ucrt-bin))
      ;; exec-path（Emacs 内からツールを探す）
      (add-to-list 'exec-path ucrt-bin)
      ;; 環境変数 PATH（Emacs が起動する sub-process 用）
      (setenv "PATH" (concat ucrt-bin ";" (getenv "PATH")))))
#+end_src
** random
ダッシュボードロゴシャッフルのためにランダムを有効化
#+begin_src emacs-lisp
  (random t)
#+end_src
** use-package
use-packageを有効化する  
melpaはstableを優先する  
最新パッケージの場合、NT Emacsではうまく動かない場合がある  
#+begin_src emacs-lisp
  (eval-and-compile
    (require 'package)
    (package-initialize)
    (add-to-list 'package-archives '("melpa-stable" . "https://stable.melpa.org/packages/") t)
    (add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/") t)
    (add-to-list 'package-archives '("gnu" . "https://elpa.gnu.org/packages/") t)

    ;; set package-archives priority
    (setq package-archive-priorities
          '(("melpa-stable" . 10)
            ("melpa" . 5)
            ("gnu" . 5)))

    ;; 組み込みパッケージの上書きアップグレードを無効化
    (setq package-install-upgrade-built-in nil)
    (setq package-native-compile t)

    ;; use-package
    (unless (package-installed-p 'use-package)
      (package-refresh-contents)
      (package-install 'use-package))

    ;; ensureは基本nil. 必要なパッケージは個別でtにする
    (setq use-package-always-ensure nil)
    (setq use-package-expand-minimally t)
    (setq use-package-compute-statistics t) ;; For "M-x use-package-report"

    ;; nerd-iconsはmelpaから取得する
    ;; nerd-icons-*関連パッケージがmelpaにしかなく、melpa-stableのnerd-iconsでは動かない場合がある
    (add-to-list 'package-pinned-packages '(nerd-icons . "melpa"))

    (require 'use-package))
#+end_src

** vc-use-package
[[https://github.com/slotThe/vc-use-package]]  
2023-05-16にEmacsのマスターへ取り込まれている  
emacs 30+を使っている場合、インストール不要で「:vc」を利用できる  
#+begin_src emacs-lisp
  (unless (package-installed-p 'vc-use-package)
    (package-vc-install "https://github.com/slotThe/vc-use-package"))
  (require 'vc-use-package)
#+end_src

** useful to IME
#+begin_src emacs-lisp
  (when (eq window-system 'w32)
    (use-package tr-ime
      :ensure t
      :defer 0.01
      :config
      (tr-ime-standard-install)
      (setq default-input-method "W32-IME")
      (w32-ime-initialize)
      ;; IME のモードライン表示設定
      (setq-default w32-ime-mode-line-state-indicator "[--]")
      (setq w32-ime-mode-line-state-indicator-list '("[--]" "[あ]" "[--]"))
      ;; IME Init
      (w32-ime-initialize)
      ;; IME Control (Turn off IME when typing yes/no, etc)
      (wrap-function-to-control-ime 'universal-argument t nil)
      (wrap-function-to-control-ime 'read-string nil nil)
      (wrap-function-to-control-ime 'read-char nil nil)
      (wrap-function-to-control-ime 'read-from-minibuffer nil nil)
      (wrap-function-to-control-ime 'y-or-n-p nil nil)
      (wrap-function-to-control-ime 'yes-or-no-p nil nil)
      (wrap-function-to-control-ime 'map-y-or-n-p nil nil)
      (wrap-function-to-control-ime 'register-read-with-preview nil nil)))
#+end_src

** so-long
長い行を含むファイルの最適化する
[[https://ayatakesi.github.io/emacs/28.1/html/Long-Lines.html]]
#+begin_src emacs-lisp
  (use-package so-long
    :ensure nil
    :init
    (global-so-long-mode 1))
#+end_src

** ターミナルモードの場合はテーマを無効にする
#+begin_src emacs-lisp
  (unless (display-graphic-p)
    (xterm-mouse-mode 1)
    ;; 端末Emacsでテーマが崩れる場合の保険。Windowsは特に差が出やすい。
    (when (and (eq system-type 'windows-nt) custom-enabled-themes)
      (disable-theme (car custom-enabled-themes))))
#+end_src

** Optimizing performance
**** プロセスからの出力の受信
[[https://ayatakesi.github.io/lispref/25.2/html/Output-from-Processes.html]]
いくつかのシステムではEmacsがサブプロセスの出力を読み取る際に出力データを非常に小さいブロックで読み取るために、
結果として潜在的に非常に貧弱なパフォーマンスとなることがある。
この挙動は変数process-adaptive-read-bufferingを非nil値(デフォルト)にセットして拡張することにより改善し得る。
これにより、そのようなプロセスからの読み取りを自動的に遅延して、Emacsが読み取りを試みる前に出力がより多く生成されるようになる。
#+begin_src emacs-lisp
  (setq process-adaptive-read-buffering t)
#+end_src
**** 閉じ括弧を入力しても点滅させない
from protesilaos
#+begin_src emacs-lisp
  (setq blink-matching-paren nil)
#+end_src
**** vcのバックエンドをGitのみに変更
from protesilaos
#+begin_src emacs-lisp
  (setq vc-handled-backends '(Git))
#+end_src

**** ファイル検索を2回行わないようにする
from doomemacs
#+begin_src emacs-lisp
  (setq auto-mode-case-fold nil)
#+end_src

**** 双方向の並び替えを抑制する
from doomemacs
#+begin_src emacs-lisp
  (setq-default bidi-display-reordering 'left-to-right)
#+end_src

**** 長い行の双方向スキャン
from doomemacs
#+begin_src emacs-lisp
  (setq bidi-inhibit-bpa t)
#+end_src

**** フォーカスされていないウィンドウのカーソルを削除
from doomemacs
#+begin_src emacs-lisp
  (setq-default cursor-in-non-selected-windows nil)
  (setq highlight-nonselected-windows nil)
#+end_src

**** 高速なスクロール
from doomemacs
#+begin_src emacs-lisp
  (setq fast-but-imprecise-scrolling t)
#+end_src

**** ドメインにpingを送信しない
from doomemacs
#+begin_src emacs-lisp
  (setq ffap-machine-p-known 'reject)
#+end_src

**** UIの更新頻度を下げる
from doomemacs
#+begin_src emacs-lisp
  (setq idle-update-delay 1.0)
#+end_src

**** 不要なフォント表示化を抑制
from doomemacs
#+begin_src emacs-lisp
  (setq redisplay-skip-fontification-on-input t)
#+end_src

**** Windowsの最適化
from doomemacs
#+begin_src emacs-lisp
  (when IS-WINDOWS
    (setq w32-get-true-file-attributes nil
          w32-pipe-read-delay 0
          w32-pipe-buffer-size (* 64 1024)))
#+end_src

**** 各OSの最適化
from Centaur Emacs
#+begin_src emacs-lisp
  (when IS-WINDOWS
    (setq w32-use-native-image-API t))
  (unless IS-MAC
    (setq command-line-ns-option-alist nil))
  (unless IS-LINUX
    (setq command-line-x-option-alist nil))
#+end_src

* UI 設定
** emacs全体構成
#+begin_src emacs-lisp
  (use-package emacs
    :ensure nil
    :init
    (when (eq system-type 'windows-nt)
      (let ((gnupg-bin "C:/Program Files (x86)/GnuPG/bin"))
        (when (file-directory-p gnupg-bin)
  	(add-to-list 'exec-path gnupg-bin)
  	(setenv "PATH" (concat gnupg-bin ";" (getenv "PATH")))))
      (setq epg-gpg-program "C:/Program Files (x86)/GnuPG/bin/gpg.exe")
      (setq package-gnupghome-dir (expand-file-name "elpa/gnupg" user-emacs-directory))
      (make-directory package-gnupghome-dir t))

    ;; フレーム生成後のGUI設定関数
    (defun my/apply-gui-frame-settings (&optional frame)
      (let ((frame (or frame (selected-frame))))
        (when (display-graphic-p frame)
  	(with-selected-frame frame
            ;; GUI整理
            (tool-bar-mode 1)
            (scroll-bar-mode 1)
            (menu-bar-mode 1)

            ;; IDEっぽいタイトル
            (setq frame-title-format
  		'(:eval
                    (format "%s — Emacs"
                            (abbreviate-file-name
                             (or (buffer-file-name)
                                 (buffer-name))))))

            ;; ウィンドウ区切り線
            (setq window-divider-default-right-width 1
  		window-divider-default-bottom-width 1)
            (window-divider-mode 1)))))

    ;; 起動後の既存フレーム
    (add-hook 'emacs-startup-hook #'my/apply-gui-frame-settings)

    ;; 新規フレーム（daemon対応）
    (add-hook 'after-make-frame-functions #'my/apply-gui-frame-settings)
    
    :custom
    ;; --- Bell / Beep 無効化---
    (ring-bell-function #'ignore)
    ;; 画面フラッシュ
    (visible-bell nil)
    ;; emacsデフォルトのスタートアップ画面表示を止める
    (inhibit-startup-screen t)
    ;; 非選択ウィンドウではカーソルを表示しない
    (cursor-in-non-selected-windows nil)
    ;; 選択した範囲の文字を削除し、入力文字に置き換える
    (delete-selection-mode t)
    ;; コンテキストメニュー表示を許可する
    (context-menu-mode t)
    ;; --- スクロール改善 ---
    (scroll-conservatively 101)
    (scroll-step 1)
    ;; pixel-scroll は Emacs 29+ で体感が良いらしい
    (pixel-scroll-precision-mode t)
    (pixel-scroll-precision-interpolate-page t)
    ;; --- ネイティブコンパイル警告抑制---
    (native-comp-async-report-warnings-errors 'silent)
    ;;  ---  行番号  --- 
    (display-line-numbers-type 'absolute)  ; 絶対行番号で表示する
    (display-line-numbers-width-start t)   ; 行番号の幅を最初から確保する
    :config
    ;; --- y-or-n-p ---
    (defalias 'yes-or-no-p 'y-or-n-p)
    ;; y-or-n-p を Return で確定できるようにする
    (advice-add 'y-or-n-p :around
                (lambda (orig-func &rest args)
    		(let ((query-replace-map (copy-keymap query-replace-map)))
                    (keymap-set query-replace-map "<return>" 'act)
                    (apply orig-func args))))
    ;; --- Windows 最適化---
    (when (eq system-type 'windows-nt)
      (setopt w32-get-true-file-attributes nil   ; ファイルI/O負荷軽減
              w32-use-native-image-API t         ; 画像APIをWindowsネイティブに
              w32-pipe-read-delay 0
              w32-pipe-buffer-size (* 64 1024)))

    ;; --- show-paren special-mode/text-mode/hexl-modeでは抑制する---
    (setopt show-paren-style 'parenthesis
            show-paren-when-point-inside-paren t
            show-paren-predicate
            (lambda (&rest _args)
              (not (or (derived-mode-p 'special-mode)
                       (derived-mode-p 'text-mode)
                       (derived-mode-p 'hexl-mode)))))
    (show-paren-mode 1)
    ;; 大文字小文字変換を許可
    (put 'upcase-region     'disabled nil)
    (put 'downcase-region   'disabled nil)
    (put 'capitalize-region 'disabled nil)

    ;; コメント継続
    (setopt comment-multi-line t)
    (advice-add 'newline-and-indent :before-until
                (lambda (&rest _)
    		(interactive "*")
    		(when-let (((nth 4 (syntax-ppss (point))))
                             ((functionp comment-line-break-function))
                             (fill-prefix " *"))
                    (funcall comment-line-break-function nil)
                    t)))
    ;; 1単語削除の機能を追加
    (defun my-backward-delete-word ()
      (interactive)
      (delete-region (point)
                     (progn (backward-word 1) (point))))

    (defun my-forward-delete-word ()
      (interactive)
      (delete-region (point)
                     (progn (forward-word 1) (point))))
    ;; 標準キーバインドを置き換え
    (global-set-key (kbd "C-<backspace>") #'my-backward-delete-word)
    (global-set-key (kbd "C-<delete>") #'my-forward-delete-word)
    ;; 括弧を自動で閉じてくれる
    (electric-pair-mode 1)
    :hook
    ((prog-mode . display-line-numbers-mode))
    ((text-mode . visual-line-mode)
     (text-mode . visual-wrap-prefix-mode))
    (prog-mode . subword-mode))
#+end_src
** フォントの設定
*** fontaineを使ったフォント設定
fontaineを使ってフォントを設定する.
「CommitMono Nerd Font Mono/Italic」を使用している.
[[https://github.com/ryanoasis/nerd-fonts]]
#+begin_src emacs-lisp
  (use-package fontaine
    :ensure t
    :defer 1
    :config
    (cond (IS-LINUX
           (setq fontaine-presets
                 '((regular
                    :default-family "CommitMono Nerd Font Mono"
  		  :default-height 120
                    :fixed-pitch-family "CommitMono Nerd Font Mono"
                    :variable-pitch-family "CommitMono Nerd Font Mono"
                    :italic-family "CommitMono Nerd Font Mono Italic")
                   (large
                    :default-family "CommitMono Nerd Font Mono"
                    :variable-pitch-family "CommitMono Nerd Font Mono"))))

          (IS-WINDOWS
           (setq fontaine-presets
                 '((regular
                    :default-family "CommitMono Nerd Font Mono"
  		  :default-height 120
                    :fixed-pitch-family "CommitMono Nerd Font Mono"
                    :variable-pitch-family "CommitMono Nerd Font Mono"
                    :italic-family "CommitMono Nerd Font Mono")
                   (large
                    :default-family "CommitMono Nerd Font Mono"
                    :variable-pitch-family "CommitMono Nerd Font Mono")))))

    (fontaine-set-preset (or (fontaine-restore-latest-preset) 'regular))
    (add-hook 'kill-emacs-hook #'fontaine-store-latest-preset))
#+end_src
** アイコン
nerd-iconsを使用している
[[https://github.com/rainstormstudio/nerd-icons.el]]
#+begin_src emacs-lisp
  (use-package nerd-icons
    :ensure t
    :defer 0.5)
  (use-package nerd-icons-completion
    :ensure t
    :hook (after-init . nerd-icons-completion-mode))
  (use-package nerd-icons-dired
    :ensure t
    :hook (dired-mode . nerd-icons-dired-mode))
  (use-package nerd-icons-corfu
    :ensure t
    :vc ( :fetcher github :repo "LuigiPiucco/nerd-icons-corfu")
    :after (corfu nerd-icons)
    :config
    (add-to-list 'corfu-margin-formatters #'nerd-icons-corfu-formatter))
  ;; リモートディレクトリでは nerd-icons-dired を無効化
  (add-hook 'dired-mode-hook
            (lambda ()
              (when (and (bound-and-true-p nerd-icons-dired-mode)
                         (file-remote-p default-directory))
                (nerd-icons-dired-mode -1))))
#+end_src
** corfu
[[https://github.com/minad/corfu]]
#+begin_src emacs-lisp
  (defun my/c-remap-indent ()
    (local-set-key [remap c-indent-line-or-region] #'indent-for-tab-command))

  (use-package corfu
    :ensure t
    :defer 1
    :config
    (setopt corfu-cycle t
            corfu-auto t
            corfu-auto-delay 0.0
            corfu-auto-prefix 2
            corfu-on-exact-match 'show)
    (with-eval-after-load 'orderless
      (defun my/orderless-for-corfu ()
        (setq-local orderless-matching-styles '(orderless-flex)))
      (add-hook 'corfu-mode-hook #'my/orderless-for-corfu))
    :init
    (global-corfu-mode 1)
    :custom
    ;; https://github.com/minad/corfu?tab=readme-ov-file#configuration
    ;; Emacs 30 and newer: Disable Ispell completion function. As an alternative,
    ;; try `cape-dict'.
    ;; 参考 : https://www.grugrut.net/posts/202408192021/
    (text-mode-ispell-word-completion . nil)
    (add-hook 'c-mode-common-hook #'my/c-remap-indent))

  ;; Corfu: 大規模候補/リモートで margin アイコンを抑制
  (with-eval-after-load 'corfu
    (defun my/corfu-maybe-disable-icons ()
      (when (or
             ;; リモートディレクトリのとき
             (file-remote-p default-directory)
             ;; 大量候補のとき（corfu--candidates は「変数」であることに注意）
             (and (boundp 'corfu--candidates)
                  (listp corfu--candidates)
                  (> (length corfu--candidates) 500)))
        (setq-local corfu-margin-formatters nil)))
    (add-hook 'corfu-mode-hook #'my/corfu-maybe-disable-icons))
#+end_src

** corfu-popup
[[https://github.com/minad/corfu/blob/main/extensions/corfu-popupinfo.el]]
corfuに含まれています
「ensure: nil」を入れておかないと、melpaへ問い合わせしてダウンロードを試みます
結果、パッケージが見つからないエラーを出力するので注意が必要です
#+begin_src emacs-lisp
  (use-package corfu-popupinfo
    :ensure nil
    :hook (corfu-mode . corfu-popupinfo-mode))
#+end_src

** corfu-magic
emacs備忘録(2024)より
[[https://qiita.com/nobuyuki86/items/122e85b470b361ded0b4#corfu-magic]]
#+begin_src emacs-lisp
  (with-eval-after-load 'corfu
    (setq corfu-preselect 'prompt)

    (define-key corfu-map (kbd "TAB") 'corfu-next)
    (define-key corfu-map (kbd "<tab>") 'corfu-next)
    (define-key corfu-map (kbd "S-TAB") 'corfu-previous)
    (define-key corfu-map (kbd "<backtab>") 'corfu-previous)

    (defvar corfu--index)
    (defvar corfu-magic-insert-or-next-line
      `(menu-item "" nil :filter ,(lambda (&optional _)
                                    (when (>= corfu--index 0)
                                      'corfu-insert)))
      "If we made a selection during `corfu' completion, select it.")
    (define-key corfu-map (kbd "RET") corfu-magic-insert-or-next-line)

    (defvar corfu-magic-cancel-or-backspace
      `(menu-item "" nil :filter ,(lambda (&optional _)
                                    (when (>= corfu--index 0)
                                      'corfu-reset)))
      "If we made a selection during `corfu' completion, cancel it.")
    (define-key corfu-map (kbd "DEL") corfu-magic-cancel-or-backspace)
    (define-key corfu-map (kbd "<backspace") corfu-magic-cancel-or-backspace))
#+end_src

** cape
[[https://github.com/minad/cape]]
capeはEmacsの組み込み補完機能を拡張するパッケージ.
corfuで利用されている
#+begin_src emacs-lisp
  (use-package cape
    :ensure t
    :defer 1
    :config
    (advice-add 'eglot-completion-at-point :around #'cape-wrap-buster)
    (advice-add 'eglot-completion-at-point :around #'cape-wrap-nonexclusive)

    (add-hook 'completion-at-point-functions #'cape-dabbrev)
    (add-hook 'completion-at-point-functions #'cape-file)
    (add-hook 'completion-at-point-functions #'cape-elisp-block))
#+end_src

*** dabbrevのサイズを制限
#+begin_src emacs-lisp
  (setq dabbrev-friend-buffer-function (lambda (other-buffer)
                                         (< (buffer-size other-buffer) (* 1024 1024))))
#+end_src

*** TABで補完を表示する
#+begin_src emacs-lisp
  (setq tab-always-indent 'complete)
#+end_src

** vertico
*** vertico
#+begin_src emacs-lisp
  (use-package vertico
    :ensure t
    :defer 1
    :init
    (setq vertico-cycle t)
    (vertico-mode))
#+end_src

*** vertico-repeat
https://github.com/minad/vertico/blob/main/extensions/vertico-repeat.el
verticoに含まれています
「ensure: nil」を入れておかないと、melpaへ問い合わせしてダウンロードを試みます
結果、パッケージが見つからないエラーを出力するので注意が必要です
#+begin_src emacs-lisp
  (use-package vertico-repeat
    :ensure nil
    :after vertico
    :hook (minibuffer-setup . vertico-repeat-save))
#+end_src

*** vertico-directory
https://github.com/minad/vertico/blob/main/extensions/vertico-directory.el
verticoに含まれています
「ensure: nil」を入れておかないと、melpaへ問い合わせしてダウンロードを試みます
結果、パッケージが見つからないエラーを出力するので注意が必要です
#+begin_src emacs-lisp
  (use-package vertico-directory
    :ensure nil
    :after vertico
    :bind ( :map vertico-map
            ("<backspace>" . vertico-directory-delete-char)))
#+end_src

*** vertico-buffer
https://github.com/minad/vertico/blob/main/extensions/vertico-buffer.el
verticoに含まれています
「ensure: nil」を入れておかないと、melpaへ問い合わせしてダウンロードを試みます
結果、パッケージが見つからないエラーを出力するので注意が必要です
#+begin_src emacs-lisp
  (use-package vertico-buffer
    :ensure nil
    :after vertico
    :config
    (setq vertico-buffer-display-action '(display-buffer-at-bottom))
    (vertico-buffer-mode))
#+end_src

*** Prefix current candidate with arrow
#+begin_src emacs-lisp
  (defvar +vertico-current-arrow t)

  (cl-defmethod vertico--format-candidate :around
    (cand prefix suffix index start &context ((and +vertico-current-arrow
                                                   (not (bound-and-true-p vertico-flat-mode)))
                                              (eql t)))
    (setq cand (cl-call-next-method cand prefix suffix index start))
    (let ((arrow (nerd-icons-faicon "nf-fa-hand_o_right")))
      (if (bound-and-true-p vertico-grid-mode)
          (if (= vertico--index index)
              (concat arrow " " cand)
            (concat #("_" 0 1 (display " ")) cand))
        (if (= vertico--index index)
            (concat " " arrow " " cand)
          (concat "    " cand)))))
#+end_src

*** vertico-truncate
#+begin_src emacs-lisp
  (use-package vertico-truncate
    :ensure t
    :after vertico
    :vc ( :fetcher github :repo "jdtsmith/vertico-truncate")
    :config
    (vertico-truncate-mode))
#+end_src

** orderless
#+begin_src emacs-lisp
  (use-package orderless
    :ensure t
    :defer 1
    :config
    (setq completion-styles '(orderless basic)
          completion-category-defaults nil
          completion-category-overrides nil)

    (with-eval-after-load 'migemo
      ;; orderlessをmigemo対応
      (defun orderless-migemo (component)
        (let ((pattern (downcase (migemo-get-pattern component))))
          (condition-case nil
              (progn (string-match-p pattern "") pattern)
            (invalid-regexp nil))))
      (add-to-list 'orderless-matching-styles 'orderless-migemo))

    (with-eval-after-load 'corfu
      (defun orderless-fast-dispatch (word index total)
        (and (= index 0) (= total 1) (length< word 4)
             'orderless-literal-prefix))

      (orderless-define-completion-style orderless-fast
        (orderless-style-dispatchers '(orderless-fast-dispatch))
        (orderless-matching-styles '(orderless-flex)))

      (defun my/setup-corfu-for-orderless ()
        (setq-local corfu-auto-delay 0
                    corfu-auto-prefix 1
                    completion-styles '(orderless-fast)))

      (add-hook 'corfu-mode-hook #'my/setup-corfu-for-orderless)))
#+end_src

** consult-line-migemo
CMigemoへ入力した文章をconsult-lineへ渡し、migemo検索を行う関数
#+begin_src emacs-lisp
  (with-eval-after-load 'consult
    (defun consult--migemo-regexp-compiler (input type &rest _config)
      (setq input (migemo-get-pattern input))
      (cons (mapcar (lambda (x) (consult--convert-regexp x type))
                    (split-string input " +" t))
            (lambda (str)
              (string-match-p input str))))

    (defun consult-line-migemo ()
      (interactive)
      (let ((consult--regexp-compiler #'consult--migemo-regexp-compiler))
        (consult-line)))

    (global-set-key (kbd "C-s") #'consult-line-migemo))
#+end_src

** consult
#+begin_src emacs-lisp
  ;; Example configuration for Consult
  (use-package consult
    :ensure t
    :defer 1
    ;; Replace bindings. Lazily loaded by `use-package'.
    :bind (;; C-c bindings in `mode-specific-map'
           ("C-c M-x" . consult-mode-command)
           ("C-c h" . consult-history)
           ("C-c k" . consult-kmacro)
           ("C-c m" . consult-man)
           ("C-c i" . consult-info)
           ([remap Info-search] . consult-info)
           ;; C-x bindings in `ctl-x-map'
           ("C-x M-:" . consult-complex-command)     ;; orig. repeat-complex-command
           ("C-x b" . consult-buffer)                ;; orig. switch-to-buffer
           ("C-x 4 b" . consult-buffer-other-window) ;; orig. switch-to-buffer-other-window
           ("C-x 5 b" . consult-buffer-other-frame)  ;; orig. switch-to-buffer-other-frame
           ("C-x t b" . consult-buffer-other-tab)    ;; orig. switch-to-buffer-other-tab
           ("C-x r b" . consult-bookmark)            ;; orig. bookmark-jump
           ("C-x p b" . consult-project-buffer)      ;; orig. project-switch-to-buffer
           ;; Custom M-# bindings for fast register access
           ("M-#" . consult-register-load)
           ("M-'" . consult-register-store)          ;; orig. abbrev-prefix-mark (unrelated)
           ("C-M-#" . consult-register)
           ;; Other custom bindings
           ("M-y" . consult-yank-pop)                ;; orig. yank-pop
           ;; M-g bindings in `goto-map'
           ("M-g e" . consult-compile-error)
           ("M-g r" . consult-grep-match)
           ("M-g f" . consult-flymake)               ;; Alternative: consult-flycheck
           ("M-g g" . consult-goto-line)             ;; orig. goto-line
           ("M-g M-g" . consult-goto-line)           ;; orig. goto-line
           ("M-g o" . consult-outline)               ;; Alternative: consult-org-heading
           ("M-g m" . consult-mark)
           ("M-g k" . consult-global-mark)
           ("M-g i" . consult-imenu)
           ("M-g I" . consult-imenu-multi)
           ;; M-s bindings in `search-map'
           ("M-s d" . consult-find)                  ;; Alternative: consult-fd
           ("M-s c" . consult-locate)
           ("M-s g" . consult-grep)
           ("M-s G" . consult-git-grep)
           ("M-s r" . consult-ripgrep)
           ("M-s l" . consult-line)
           ("M-s L" . consult-line-multi)
           ("M-s k" . consult-keep-lines)
           ("M-s u" . consult-focus-lines)
           ;; Isearch integration
           ("M-s e" . consult-isearch-history)
           :map isearch-mode-map
           ("M-e" . consult-isearch-history)         ;; orig. isearch-edit-string
           ("M-s e" . consult-isearch-history)       ;; orig. isearch-edit-string
           ("M-s l" . consult-line)                  ;; needed by consult-line to detect isearch
           ("M-s L" . consult-line-multi)            ;; needed by consult-line to detect isearch
           ;; Minibuffer history
           :map minibuffer-local-map
           ("M-s" . consult-history)                 ;; orig. next-matching-history-element
           ("M-r" . consult-history))                ;; orig. previous-matching-history-element

    ;; The :init configuration is always executed (Not lazy)
    :init

    ;; Tweak the register preview for `consult-register-load',
    ;; `consult-register-store' and the built-in commands.  This improves the
    ;; register formatting, adds thin separator lines, register sorting and hides
    ;; the window mode line.
    (advice-add #'register-preview :override #'consult-register-window)
    (setq register-preview-delay 0.5)

    ;; Use Consult to select xref locations with preview
    (setq xref-show-xrefs-function #'consult-xref
          xref-show-definitions-function #'consult-xref)

    ;; Configure other variables and modes in the :config section,
    ;; after lazily loading the package.
    :config

    ;; Optionally configure preview. The default value
    ;; is 'any, such that any key triggers the preview.
    ;; (setq consult-preview-key 'any)
    ;; (setq consult-preview-key "M-.")
    ;; (setq consult-preview-key '("S-<down>" "S-<up>"))
    ;; For some commands and buffer sources it is useful to configure the
    ;; :preview-key on a per-command basis using the `consult-customize' macro.
    (consult-customize
     consult-theme :preview-key '(:debounce 0.2 any)
     consult-ripgrep consult-git-grep consult-grep consult-man
     consult-bookmark consult-recent-file consult-xref
     consult-source-bookmark consult-source-file-register
     consult-source-recent-file consult-source-project-recent-file
     ;; :preview-key "M-."
     :preview-key '(:debounce 0.4 any))

    ;; Optionally configure the narrowing key.
    ;; Both < and C-+ work reasonably well.
    (setq consult-narrow-key "<") ;; (kbd "C-+")
    )
#+end_src

** marginalia
vertico の候補に情報を追加する.
#+begin_src emacs-lisp
  (use-package marginalia
    :ensure t
    :defer 1
    :init
    (marginalia-mode 1))
#+end_src
** magit
#+begin_src emacs-lisp
  (use-package magit
    :ensure t
    :defer t
    :config
    (when IS-WINDOWS
      (setq magit-refresh-status-buffer nil)
      (setq auto-revert-buffer-list-filter
            'magit-auto-revert-repository-buffer-p)
      (remove-hook 'magit-refs-sections-hook 'magit-insert-tags)
      (remove-hook 'server-switch-hook 'magit-commit-diff)
      (remove-hook 'with-editor-filter-visit-hook 'magit-commit-diff)))
#+end_src

** diff-hl
*** diff-hl
ウィンドウの左側にコミットされていない箇所を強調表示する
#+begin_src emacs-lisp
  (use-package diff-hl
    :ensure t
    :hook ((magit-pre-refresh . diff-hl-magit-pre-refresh)
           (magit-post-refresh . diff-hl-magit-post-refresh)
           (dired-mode . diff-hl-dired-mode))
    :config
    ;; バッファ全体で git 差分を左側に表示
    (global-diff-hl-mode)
    ;; マウスでhunkを表示
    (global-diff-hl-show-hunk-mouse-mode)
    ;; 左マージンに表示
    (diff-hl-margin-mode))
#+end_src

*** difftastic
Emacsでdifftasticを使用できるようにする.
通常のコマンドとしても使用でき、magitにも統合
#+begin_src emacs-lisp
  (use-package difftastic
    :ensure t
    :defer t
    :commands (difftastic-buffer difftastic-region difftastic-dwim)
    :bind (("C-c d b" . difftastic-buffer)
           ("C-c d r" . difftastic-region)
           ("C-c d d" . difftastic-dwim)))
#+end_src

** which-key
キーバインドの可視化
#+begin_src emacs-lisp
  (use-package which-key
    :ensure t
    :defer 1
    :config
    (setq which-key-idle-delay 0.8)
    (which-key-mode 1))
#+end_src

** undo
*** undo-fua
Emacsのundoとredoを強化するパッケージです
#+begin_src emacs-lisp
  (use-package undo-fu
    :ensure t
    :defer 2)
#+end_src

*** undo-fu-session
undo情報をEmacs終了後も保持してくれるようになる
#+begin_src emacs-lisp
  (use-package undo-fu-session
    :ensure t
    :defer 2
    :config
    (undo-fu-session-global-mode))
#+end_src

*** vundo
undo履歴を視覚的に分かりやすく表示してくれる
[[https://github.com/casouri/vundo]]
#+begin_src emacs-lisp
  (use-package vundo
    :ensure t
    :defer 2)
#+end_src

** modus-themes
#+begin_src emacs-lisp
  ;;(use-package modus-themes
  ;;  :demand t
  ;;  :config
  ;;  (setq modus-themes-italic-constructs t
  ;;        modus-themes-bold-constructs nil
  ;;        modus-themes-mixed-fonts t
  ;;        modus-themes-variable-pitch-ui t
  ;;        modus-themes-disable-other-themes t)
  ;;
  ;;  (setq modus-themes-completions
  ;;        '((t . (underline))))
  ;;
  ;;  (setq modus-themes-common-palette-overrides
  ;;        '((fg-completion-match-0 blue)
  ;;          (fg-completion-match-1 magenta-warmer)
  ;;          (fg-completion-match-2 cyan)
  ;;          (fg-completion-match-3 red)
  ;;          (bg-completion-match-0 bg-blue-nuanced)
  ;;          (bg-completion-match-1 bg-magenta-nuanced)
  ;;          (bg-completion-match-2 bg-cyan-nuanced)
  ;;          (bg-completion-match-3 bg-red-nuanced)))
  ;;
  ;;  ;;(load-theme 'modus-operandi-tinted t)
  ;;  (load-theme 'modus-vivendi-tinted t))
  (setq modus-themes-italic-constructs t
        modus-themes-bold-constructs nil
        modus-themes-mixed-fonts t
        modus-themes-variable-pitch-ui t
        modus-themes-disable-other-themes t)

  (setq modus-themes-completions
        '((t . (underline))))

  (setq modus-themes-common-palette-overrides
        '((fg-completion-match-0 blue)
          (fg-completion-match-1 magenta-warmer)
          (fg-completion-match-2 cyan)
          (fg-completion-match-3 red)
          (bg-completion-match-0 bg-blue-nuanced)
          (bg-completion-match-1 bg-magenta-nuanced)
          (bg-completion-match-2 bg-cyan-nuanced)
          (bg-completion-match-3 bg-red-nuanced)))

  (load-theme 'modus-vivendi-tinted t)
#+end_src

** hl-line-mode
hl-line-mode
#+begin_src emacs-lisp
  (global-hl-line-mode 1)
#+end_src

** pulsar
カーソルの移動を視覚的に分かりやすくしてくれる
#+begin_src emacs-lisp
  (use-package pulse)
  (defun my/pulse-line () (pulse-momentary-highlight-one-line (point)))
  (add-hook 'next-error-hook #'my/pulse-line)
  (advice-add 'yank :after (lambda (&rest _) (pulse-momentary-highlight-region (mark t) (point))))
#+end_src
** spacious-padding
スペースを設定して、見やすくします。
[[https://github.com/protesilaos/spacious-padding?tab=readme-ov-file]]
#+begin_src emacs-lisp
  (use-package spacious-padding
    :ensure t
    :defer 1
    :config
    (setq spacious-padding-widths
          '( :internal-border-width 15
             :header-line-width 4
             :mode-line-width 6
             :tab-width 2
             :right-divider-width 30
             :scroll-bar-width 8))

    ;; Read the doc string of `spacious-padding-subtle-mode-line' as it
    ;; is very flexible and provides several examples.
    (setq spacious-padding-subtle-mode-line
          `( :mode-line-active 'default
             :mode-line-inactive vertical-border))

    (spacious-padding-mode))
#+end_src

** perfect-mergin
バッファが1つの時、中央に表示します。2つ以上の時は通常の表示に戻ります。
[[https://github.com/mpwang/perfect-margin]]
#+begin_src emacs-lisp
  ;;  (use-package perfect-margin
  ;;    :defer 1
  ;;    :config
  ;;    (setq perfect-margin-ignore-filters nil)
  ;;    (setq perfect-margin-only-set-left-margin t)
  ;;    (perfect-margin-mode))
  (pixel-scroll-precision-mode 1)
#+end_src

** breadcrumb
バッファ上部にパンくずリストを表示してくれます。
#+begin_src emacs-lisp
  (use-package breadcrumb
    :ensure t
    :vc (:fetcher github :repo "joaotavora/breadcrumb")
    :config
    (breadcrumb-mode 1))
#+end_src

** rainbow-delimiters
括弧に色を付けて見やすくします。
#+begin_src emacs-lisp
  (use-package rainbow-delimiters
    :ensure t
    :defer 1
    :hook (prog-mode . rainbow-delimiters-mode))
#+end_src

** imenu-list
#+begin_src emacs-lisp
  (use-package imenu-list
    :defer 1
    :init
    (setq imenu-list-position 'left))
#+end_src

** autorevert
Check for file updates and update buffers as well.
#+begin_src emacs-lisp
  (use-package autorevert
    :ensure nil
    :hook (after-init . global-auto-revert-mode))
#+end_src

** helpful
ヘルプバッファの機能を強化する
#+begin_src emacs-lisp
  (use-package helpful
    :ensure t
    :commands (helpful-callable helpful-variable helpful-key helpful-command helpful-at-point)
    :bind
    (("C-h f" . helpful-callable)   ;; describe-function
     ("C-h v" . helpful-variable)   ;; describe-variable
     ("C-h k" . helpful-key)        ;; describe-key
     ("C-h x" . helpful-command)    ;; describe-command
     ("C-c C-d" . helpful-at-point)) ;; 任意：ポイントのものを表示
    :custom
    (elisp-refs-verbose nil)
    :config
    ;; helpful buffer でツールバー/見た目が崩れる場合の保険（任意）
    (add-hook 'helpful-mode-hook
              (lambda ()
                (setq-local tool-bar-map help-mode-tool-bar-map))))
#+end_src
** indent-bars
インデントの範囲を分かりやすくする
#+begin_src emacs-lisp
  (use-package indent-bars
    :ensure t
    :hook (prog-mode . indent-bars-mode)
    :custom
    (indent-bars-treesit-support nil) ;; treesitは使わない
    (indent-bars-pattern ".")
    (indent-bars-width-frac 0.1)
    (indent-bars-pad-frac 0.1))
#+end_src
** project
gitなどのプロジェクトを管理しやすくする
#+begin_src emacs-lisp
  (use-package project
    :ensure nil
    :custom
    (project-vc-extra-root-markers
     '(".project" ".dir-locals.el" "*.gemspec" "autogen.sh" "GTAGS" "TAGS"
       "configure.ac" "configure.in" "cscope.out" "rebar.config" "project.clj"
       "build.boot" "deps.edn" "SConstruct" "default.nix" "flake.nix" "pom.xml"
       "build.sbt" "build.sc" "gradlew" "build.gradle" ".ensime" "Gemfile"
       "requirements.txt" "setup.py" "tox.ini" "composer.json" "Cargo.toml"
       "mix.exs" "stack.yaml" "dune-project" "info.rkt" "DESCRIPTION" "TAGS"
       "GTAGS" "configure.in" "autoconf old styl" "configure.ac" "cscope.out"
       "CMakeLists.txt" "WORKSPACE" "debian/control"))
    (project-vc-ignores '(".elc" ".pyc" ".o" ".github"))
    :config
    ;; Better Project.el Menu
    (keymap-unset (current-global-map) "<menu-bar> <tools> <project>")

    (keymap-set-after (default-value 'menu-bar-project-menu) "<ripgrep-search>"
      '(menu-item "Find with ripgrep (rg)" rg-project-el)
      'project-or-external-find-regexp)

    (keymap-set-after (default-value 'menu-bar-project-menu) "<dir-locals>"
      '(menu-item "Customize Dirlocals" customize-dirlocals)
      'project-switch-project)

    (keymap-set-after (default-value 'menu-bar-project-menu) "<build-command>"
      '(menu-item "Set Build Command" projection-commands-set-build-command
  		:help
  		"The command to use with projection-commands-build-project.
  You can set via .dir-locals.el too.")
      'dir-locals)

    (keymap-set-after (default-value 'menu-bar-project-menu) "<run-command>"
      '(menu-item "Set Run Command" projection-commands-set-run-command
  		:help
  		"The command to use with projection-commands-run-project.
  You can set via .dir-locals.el too.")
      'build-command)

    (keymap-set-after (default-value 'menu-bar-project-menu) "<build>"
      '(menu-item "Build Project..." projection-commands-build-project)
      'project-compile)

    (keymap-set-after (default-value 'menu-bar-project-menu) "<run>"
      '(menu-item "Run Project..." projection-commands-run-project)
      'build)

    (keymap-set-after (current-global-map) "<menu-bar> <projects>"
      menu-bar-project-item
      'tools)

    ;; (put 'projection-commands-run-command 'custom-type (purecopy '(choice (string :tag "String") (other :tag "Nothing"))))
    ;; (put 'projection-commands-build-command 'custom-type (purecopy '(choice (string :tag "String") (other :tag "Nothing"))))
    ;; (put 'projection-commands-configure-command 'custom-type (purecopy '(choice (string :tag "String") (other :tag "Nothing"))))

    (let ((type (purecopy '(choice (string :tag "String") (other :tag "Nothing")))))
      (put 'projection-commands-run-command 'custom-type type)
      (put 'projection-commands-configure-command 'custom-type type)
      (put 'projection-commands-build-command 'custom-type type))

    (use-package projection
      :ensure projection-multi
      :hook
      (after-init . global-projection-hook-mode)
      :config
      (use-package consult-compile-multi
        :ensure t
        :after compile-multi
        :demand t
        :config (consult-compile-multi-mode))))
#+end_src
** toolbar
#+begin_src emacs-lisp
  (when (display-graphic-p)
    (setopt tool-bar-style 'image)
    ;; For Lucid ToolKit
    (set-face-attribute 'tool-bar nil :inherit 'tab-bar-tab-inactive)
    (set-face-attribute 'tool-bar nil :box nil)
    (if (eq system-type 'android)
        (progn
          (setopt tool-bar-position 'bottom)
          (modifier-bar-mode t))
      (setopt tool-bar-position 'bottom))

    (tool-bar-add-item-from-menu 'undo-redo "redo" nil) ; Redo

    (keymap-set-after (default-value 'tool-bar-map) "<undo-redo>"
      (cdr (assq 'undo-redo tool-bar-map))
      'undo)

    (if (functionp 'vundo)
        (keymap-set-after (default-value 'tool-bar-map) "<vundo>"
          '(menu-item "Undo Tree" vundo
                      :help "Show Visual Undo"
                      :visible (or (derived-mode-p 'prog-mode)
                                   (derived-mode-p 'text-mode))
                      :image (find-image '((:type png :file "tree-widget/default/open.png"))))
          'isearch-forward))
    (keymap-set-after (default-value 'tool-bar-map) "<explorer>"
      '(menu-item "Explorer" my/explorer-open
                  :help "Hide/Show Side Explorer"
                  :visible (or (derived-mode-p 'prog-mode)
                               (derived-mode-p 'text-mode))
                  :image (find-image `((:type svg :file ,(concat user-emacs-directory "assets/tree_explorer.svg")))))
      'isearch-forward)

    (keymap-set-after (default-value 'tool-bar-map) "<separator-4>"
      '(menu-item "" nil
                  :visible (derived-mode-p 'prog-mode))
      'my/explorer-open)

    (keymap-set-after (default-value 'tool-bar-map) "<build>"
      '(menu-item "Build Project" my/build-command
                  :help "Build/Compile Project"
                  :visible (derived-mode-p 'prog-mode)
                  :image (find-image `((:type svg :file ,(concat user-emacs-directory "assets/build_exec.svg")))))
      'my/explorer-open)

    (keymap-set-after (default-value 'tool-bar-map) "<debug>"
      '(menu-item "Debug Project" dape
                  :help "Debug Project"
                  :visible (derived-mode-p 'prog-mode)
                  :image (find-image `((:type svg :file ,(concat user-emacs-directory "assets/debug_exc.svg")))))
      'my/build-command)

    (keymap-set-after (default-value 'tool-bar-map) "<run-program>"
      '(menu-item "Run Project" my/run-program
                  :help "Run Project"
                  :visible (derived-mode-p 'prog-mode)
                  :image (find-image `((:type svg :file ,(concat user-emacs-directory "assets/run_exc.svg")))))
      'dape)

    (keymap-set-after (default-value 'tool-bar-map) "<separator-5>"
      menu-bar-separator 'dap-debug-last) ; Add Separator

    (keymap-set-after (default-value 'tool-bar-map) "<packages>"
      '(menu-item "packages" list-packages
                  :help   "Show List Packages"
                  :image (find-image `((:type svg :file ,(concat user-emacs-directory "assets/elpa.svg")))))
      'my/run-program)
    (keymap-set-after (default-value 'tool-bar-map) "<dashboard>"
      '(menu-item "Dashboard" dashboard-open
                  :help "Back to Startpage"
                  :image (find-image '((:type xpm :file "home.xpm"))))
      'list-packages)
    (keymap-set-after (default-value 'tool-bar-map) "<customize>"
      '(menu-item "Settings" customize
                  :help "Show Settings Buffer"
                  :image (find-image '((:type xpm :file "preferences.xpm"))))
      'dashboard-open))  
#+end_src
** menubar
#+begin_src emacs-lisp

#+end_src

** treemacs
#+begin_src emacs-lisp
  ;; Define which file manager use
  ;; (e.g 'treemacs' or 'dirvish-side').
  (defalias 'my/explorer-open 'treemacs)
  ;; dired+ (optional):
  ;; (load (concat user-emacs-directory "config-lisp-files/" "diredp"))

   ;;; DIRED CONFIGURATIONS
  (use-package dired-x
    :ensure nil
    :custom
    (dired-mouse-drag-files t)
    (dired-omit-files
     (rx (or (seq bol (one-or-more "flycheck_"))
             (seq bol (? ".") "#")
             (seq bol "." eol)
             (seq bol ".." eol)))))

   ;;; DIRVISH
  (use-package dirvish
    :ensure t
    :hook
    (dired-mode . auto-revert-mode)
    (dirvish-find-entry
     . (lambda (&rest _)
         (interactive)
         (dired-omit-mode)
         (setq-local truncate-lines t
                     mouse-1-click-follows-link 'double)))
    :custom
    (delete-by-moving-to-trash t)
    (dirvish-subtree-always-show-state t)
    (dirvish-side-follow-mode t)
    (dirvish-side-width 31)
    (dirvish-subtree-state-style 'nerd)
    (dirvish-attributes
     '(nerd-icons
       subtree-state
       git-msg
       file-time
       vc-stat))
    (dirvish-path-separators
     (list (format "  %s " (nerd-icons-codicon "nf-cod-home"))
           (format "  %s " (nerd-icons-codicon "nf-cod-root_folder"))
           (format " %s " (nerd-icons-faicon "nf-fa-angle_right"))))
    (dirvish-override-dired-mode t)
    (dirvish-reuse-session nil)
    (dirvish-use-mode-line nil)
    (dired-listing-switches
     "-l --almost-all --human-readable --group-directories-first --no-group")
    :bind
    (:map dirvish-mode-map
          ("<remap> <kill-this-buffer>" . dirvish-quit)
          ("TAB"       . dirvish-subtree-toggle)
          ("<delete>"  . dired-do-delete)
          ("<double-mouse-1>" . dirvish-subtree-toggle-or-open))
    (:map dirvish-directory-view-mode-map
          ("<remap> <kill-this-buffer>" . dirvish-quit)
          ("<double-mouse-1>" . dired-find-file)
          ("RET"              . dired-find-file)))

  ;;; TREEMACS
  
  (use-package treemacs
    :ensure t
    :demand t
    :hook (treemacs-mode . (lambda () (setq-local context-menu-mode nil)))
    :bind
    (:map treemacs-mode-map
          ("<delete>" . treemacs-delete-file))
    :custom
    (treemacs-filewatch-mode t)
    (treemacs-fringe-indicator-mode nil)
    (treemacs-indent-guide-mode t)
    (treemacs-indentation 1)
    (treemacs-is-never-other-window t)
    (treemacs-project-follow-mode t)
    (treemacs-user-mode-line-format 'none)
    (treemacs-width 37)
    :preface
    (defun doom-themes-enable-treemacs-variable-pitch-labels (&rest _)
      (dolist (face '(treemacs-root-face
                      treemacs-git-unmodified-face
                      treemacs-git-modified-face
                      treemacs-git-renamed-face
                      treemacs-git-ignored-face
                      treemacs-git-untracked-face
                      treemacs-git-added-face
                      treemacs-git-conflict-face
                      treemacs-directory-face
                      treemacs-directory-collapsed-face
                      treemacs-file-face
                      treemacs-tags-face))
        (let ((faces (face-attribute face :inherit nil)))
          (set-face-attribute
           face nil :inherit
           `(variable-pitch
             ,@(delq 'unspecified (if (listp faces) faces (list faces))))))))
    :config
    (set-window-fringes (treemacs-get-local-window) 0 0 nil)
    (doom-themes-enable-treemacs-variable-pitch-labels)
    (treemacs-resize-icons 14)
    (advice-add #'load-theme
                :after #'doom-themes-enable-treemacs-variable-pitch-labels)
    (use-package treemacs-nerd-icons
      :ensure t
      :functions treemacs-load-theme
      :preface
      (defun treemacs--propagate-new-icons (_theme))
      :custom-face (cfrs-border-color ((t (:inherit posframe-border))))
      :config (treemacs-load-theme "nerd-icons")))
#+end_src
** theme
emacs-dashboardの設定時、利用しているテーマ
#+begin_src emacs-lisp
  (use-package solaire-mode
    :ensure t
    :if (display-graphic-p)
    :config
    (add-to-list #'solaire-mode-remap-alist
                 '(treemacs-hl-line-face . solaire-hl-line-face))
    (add-to-list #'solaire-mode-remap-alist
                 '(treemacs-window-background-face . solaire-default-face))
    (solaire-global-mode t))
#+end_src
** ランダムロゴ
#+begin_src emacs-lisp
  (defun my/dashboard-random-logo ()
    "Pick a random image from logo directory."
    (let* ((logo-dir (expand-file-name "logo/" user-emacs-directory))
  	 (images (directory-files logo-dir t "\\.png$")))
      (when images
        (nth (random (length images)) images))))
#+end_src
** ダッシュボード
emacs-dashboardを利用する
最新バージョンを利用しないと、ボタンを画面下部に出すことが出来ない
#+begin_src emacs-lisp
  (defun my/dashboard-choose-random-banner ()
    (setq dashboard-startup-banner
  	(my/dashboard-random-logo)))

  (use-package dashboard
    :ensure t
    :hook
    (window-configuration-change
     . (lambda ()
         "Quit treemacs window when in dashboard"
         (if (and (or (dirvish-side--session-visible-p)
                      (windowp (treemacs-get-local-window)))
     		(derived-mode-p 'dashboard-mode))
             (delete-window (treemacs-get-local-window)))))
    ;; ランダムバナー関数を初期化する
    (dashboard-before-initialize . my/dashboard-choose-random-banner)
    (after-init . dashboard-setup-startup-hook)
    ;; solaire-modeをインストールする必要がある
    (dashboard-before-initialize . turn-on-solaire-mode)
    (dashboard-mode . (lambda ()
                        (setq-local left-fringe-width 0
                                    right-fringe-width 0
                                    left-margin-width 0
                                    right-margin-width 0)
                        (widget-forward 1)))
    (dashboard-before-initialize . my/dashboard-choose-random-banner)
    (after-init . dashboard-setup-startup-hook)
    :bind
    (:map dashboard-mode-map
     	("<f5>" . dashboard-open)
     	("<remap> <dashboard-previous-line>" . widget-backward)
     	("<remap> <dashboard-next-line>" . widget-forward)
     	("<remap> <previous-line>" . widget-backward)
     	("<remap> <next-line>"  . widget-forward)
     	("<remap> <right-char>" . widget-forward)
     	("<remap> <left-char>"  . widget-backward))

    :custom-face
    (dashboard-banner-logo-title ((t (:height 2.0 :weight ultra-heavy :inherit (variable-pitch)))))
    :custom
    (dashboard-banner-logo-title "EMACS KATSUDOU !")
    (dashboard-footer-messages '("MIKURU's MIRACLE"))
    (dashboard-startup-banner
     `(,(or (my/dashboard-random-logo)  ; my/dashboard-random-logo is original function.
  	  (expand-file-name "logo/straylight_mark.png" user-emacs-directory))
       . nil)) 
    (dashboard-icon-type 'nerd-icons) ; use `nerd-icons' package
    (dashboard-vertically-center-content nil)
    (dashboard-center-content t)
    (dashboard-display-icons-p t) ; display icons on both GUI and terminal
    (dashboard-path-style 'truncate-middle)
    (dashboard-path-max-length 50)
    (dashboard-items '((projects . 7)
   		     (recents  . 9)))
    (dashboard-set-file-icons t)
    (dashboard-set-heading-icons t)
    (dashboard-heading-icons '((recents   . "nf-oct-history")
                               (bookmarks . "nf-oct-bookmark")
                               (agenda    . "nf-oct-calendar")
                               (projects  . "nf-oct-rocket")
                               (registers . "nf-oct-database")))
    (dashboard-footer-icon `(,(nerd-icons-devicon "nf-dev-emacs" :height 1.2 :face 'nerd-icons-purple)
                             ,(nerd-icons-mdicon "nf-md-microsoft_visual_studio_code" :height 1.2 :face 'nerd-icons-blue)))
    (dashboard-heading-shorcut-format (propertize " [%s]" 'face 'shadow))
    (dashboard-startupify-list `(dashboard-insert-banner
                                 dashboard-insert-banner-title
                                 dashboard-insert-init-info
                                 ,(dashboard-insert-newline 2)
                                 dashboard-insert-footer
                                 (lambda () (delete-char -1))
                                 dashboard-insert-items
                                 dashboard-insert-navigator
                                 dashboard-insert-newline))
    ;; nerd-icons が使えるようになってからボタンを作る
    :config
    (with-eval-after-load 'nerd-icons
      (let ((l (nerd-icons-powerline "nf-ple-left_half_circle_thick"
                                     :face 'dashboard-navigator :height 1.5))
            (r (nerd-icons-powerline "nf-ple-right_half_circle_thick"
                                     :face 'dashboard-navigator :height 1.5)))
        (setq dashboard-navigator-buttons
              `((;; line1
                 (,(nerd-icons-faicon "nf-fa-file_text_o")
     		"Open File"
     		"Open External File"
     		(lambda (&rest _) (menu-find-file-existing))
     		(:inverse-video t :inherit dashboard-navigator) ,l ,r)
                 (,(nerd-icons-octicon "nf-oct-rocket")
     		"Projects"
     		"Open Project"
     		(lambda (&rest _)
                    (if project--list
                        (call-interactively #'project-switch-project)
                      (call-interactively #'project-remember-projects-under)))
     		(:inverse-video t :inherit dashboard-navigator) ,l ,r)
     	       (,(nerd-icons-octicon "nf-oct-code_square")
     		" Edit init file"     ; Title
     		"Open and Edit Emacs init file"   ; Description
     		(lambda (&rest _) (find-file user-init-file))
     		(:inverse-video t :inherit dashboard-navigator) ,l ,r)
     	       )
                (;; line2
                 (,(nerd-icons-mdicon "nf-md-package_variant")
     		"Search Packages"
     		"Search and install Emacs Packages"
     		(lambda (&rest _) (list-packages))
     		(:inverse-video t :inherit dashboard-navigator) ,l ,r)
                 (,(nerd-icons-octicon "nf-oct-gear")
     		"Settings"
     		"Open settings"
     		(lambda (&rest _) (customize))
     		(:inverse-video t :inherit dashboard-navigator) ,l ,r)))))))
#+end_src

** mode line
*** hide-mode-line
#+begin_src emacs-lisp
  (use-package minions
    :ensure t
    :custom
    (minions-mode-line-lighter "…")
    :hook (doom-modeline-mode . minions-mode))

  (use-package hide-mode-line
    :ensure t
    :hook (((treemacs-mode
             eshell-mode shell-mode term-mode vterm-mode
             embark-collect-mode
  	   woman-mode
             dap-ui-breakpoints-ui-list-mode
             flymake-diagnostics-buffer-mode
             flymake-project-diagnostics-mode
             emacs-lisp-compilation-mode flycheck-error-list-mode
             dashboard-mode Custom-mode pdf-annot-list-mode)
            . hide-mode-line-mode)))
#+end_src

*** doom-modeline
#+begin_src emacs-lisp
  (use-package doom-modeline
    :ensure t
    :hook (after-init . doom-modeline-mode)
    :custom
    (doom-modeline-height 28)
    (doom-modeline-bar-width 3)
    (doom-modeline-icon t)
    (doom-modeline-buffer-state-icon t)
    (doom-modeline-minor-modes t)
    (doom-modeline-modal-icon t)
    (doom-modeline-checker-simple-format nil)
    (doom-modeline-lsp t)
    (doom-modeline-vcs t)
    (doom-modeline-buffer-encoding t)
    (doom-modeline-indent-info t)
    (doom-modeline-input-method nil)

    ;; ノイズ源は抑える
    (doom-modeline-irc nil)
    (doom-modeline-env-version nil)
    (doom-modeline-time nil)

    :config
    (set-face-attribute 'doom-modeline-bar nil :background 'unspecified)
    (set-face-attribute 'doom-modeline-bar nil :inherit 'mode-line)

    ;; main を組み直し
    ;; Configure Some Modeline
    (doom-modeline-def-modeline 'main
      '(bar matches workspace-name window-number follow modals
            buffer-info remote-host " " check lsp debug parrot " "
            compilation process misc-info)
      '(vcs media-info indent-info input-method buffer-encoding
            buffer-position word-count pdf-pages major-mode
            minor-modes))
    (doom-modeline-set-modeline 'main t)

    ;; dashboard は専用（後述）
    (add-to-list 'doom-modeline-mode-alist '(dashboard-mode . main)))
#+end_src
* Programing language config
** c/c++ mode
#+begin_src emacs-lisp
  (use-package cc-mode
    :ensure nil
    :defer 1
    :config
    (setq c-default-style "bsd")
    (setq c-basic-offset 2)       ; basic indent value
    (setq tab-width 2)            ; tab width
    (setq indent-tabs-mode nil)   ; indent use space.
    (c-set-offset 'innamespace 0) ; namespace indent pos is 0
    )
#+end_src

** clang-format
「.clang-format」はユーザーフォルダの直下にあれば良い様子
#+begin_src emacs-lisp
  (use-package clang-format
    :ensure t
    :commands (clang-format-buffer clang-format-on-save-mode)
    ;;:hook ((c-mode . clang-format-on-save-mode)
    ;;       (c++-mode . clang-format-on-save-mode))
    :config
    (setq clang-format-style "file")           ; .clang-format を参照
    (setq clang-format-fallback-style "none")) ; .clang-format がない場合は何もしない
#+end_src

** glsl-mode
#+begin_src emacs-lisp
  (use-package glsl-mode
    :defer 5
    :config
    (add-to-list 'auto-mode-alist '("\.vsh$" . glsl-mode))
    (add-to-list 'auto-mode-alist '("\.fsh$" . glsl-mode)))
#+end_src

** markdown
#+begin_src emacs-lisp
  (use-package markdown-mode
    :ensure t
    :defer 3
    :mode ("\\.md\\'" . gfm-mode)
    ;; need to installed "pandoc.exe" and set environment path for pandoc.exe.
    :config
    (when (eq system-type 'windows-nt)
      (setq markdown-command "pandoc.exe -s --standalone --metadata pagetitle=markdown -t html5 -c https://cdn.jsdelivr.net/npm/github-markdown-css@3.0.1/github-markdown.css"))
    (unless (eq system-type 'windows-nt)
      (setq markdown-command "pandoc -s --standalone --metadata pagetitle=markdown -t html5 -c https://cdn.jsdelivr.net/npm/github-markdown-css@3.0.1/github-markdown.css"))
    (setq markdown-fontify-code-blocks-natively t))
#+end_src

** cmake-mode
#+begin_src emacs-lisp
  (use-package cmake-mode
    :ensure t
    :defer 1)
#+end_src

** Dart-mode
#+begin_src emacs-lisp
  (use-package dart-mode
    :ensure t
    :defer 1)
#+end_src

** Java
eglotよりも先に読み込む必要があるっぽいです。
eglot単体の場合、jdtlsをPATHから探します。
eglot-javaが読み込まれていると上述処理を上書きし、jdtlsの最新バージョンをダウンロードしてくれます。
#+begin_src emacs-lisp
  (use-package eglot-java
    :ensure t
    :demand t
    :config
    (eglot-java-mode))
#+end_src

eglot-javaがjdtlsを起動する際にlombok.jarを引数として追加します。
vcパラメータ等が上手く動かなかったのでダウンロードして配置しました。
参考: https://github.com/ltylty/eglot-java-lombok
#+begin_src emacs-lisp
  (use-package eglot-java-lombok
    :ensure nil
    :demand t
    :load-path "~/.emacs.d/external/eglot-java-lombok"
    :config
    (eglot-java-lombok/init))
#+end_src

** About web
*** web-mode
#+begin_src emacs-lisp
  (use-package web-mode
    :ensure t
    :mode ("\\.html?\\'" "\\.jsx?\\'" "\\.vue\\?'")
    :defer 1
    :config
    (setq web-mode-markup-indent-offset 2
          web-mode-css-indent-offset 2
          web-mode-code-indent-offset 2
          web-mode-enable-auto-quoting 2
          indent-tabs-mode nil
          tab-width 2))
#+end_src

** editorconfig
30.1から、editorconfigはemacs masterに統合されたらしい
統合されているのなら、ensure nilにしないとmelpaなどから取得してしまう。
#+begin_src emacs-lisp
  (use-package editorconfig
  :defer 2
  :ensure nil
  :config
  (editorconfig-mode)
  (setq editorconfig-exec-path "~/.emacs.d/editorconfig/.editorconfig"))
#+end_src

** eglot config
*** eglot
#+begin_src emacs-lisp
  (progn
    (customize-set-variable 'eglot-autoshutdown t)
    (customize-set-variable 'eglot-extend-to-xref t)
    (customize-set-variable 'eglot-ignored-server-capabilities
                            (quote (:documentFormattingProvider :documentRangeFormattingProvider)))

    (with-eval-after-load 'eglot
      ;; timeout
      (setq eglot-connect-timeout 120)

      ;; c/c++
      (add-to-list 'eglot-server-programs
                   '((c-mode c++-mode)
                     . ("clangd"
                        "-j=2"
                        "--log=error"
                        "--background-index=false"
                        "--clang-tidy"
                        "--cross-file-rename"
                        "--completion-style=detailed"
                        "--pch-storage=disk"
                        "--header-insertion=never"
                        "--header-insertion-decorators=0")))
      ;; Java
      ;; project.elはemacs標準のvc.elを使ってgitを検索している
      ;; (locate-dominating-file default-directory ".git")
      ;; 上述のS式をjavaファイルなどを開いているバッファで実行(M-:)すると、ルートディレクトリが分かる
      ;; Gradle/Maven の自動 import を止め、初期化を軽量化します。
      (setq eglot-java-jdtls-settings
      '((java.import.gradle.enabled . :json-false)
        (java.import.maven.enabled  . :json-false)))

      ;; Language Serverからの進捗を表示するか否か
      (setq eglot-report-progress nil))

    (with-eval-after-load 'flymake
      (define-key flymake-mode-map (kbd "C-c ! n") nil)
      (define-key flymake-mode-map (kbd "C-c ! p") nil)
      (define-key flymake-mode-map (kbd "C-c n") 'flymake-goto-next-error)
      (define-key flymake-mode-map (kbd "C-c p") 'flymake-goto-prev-error))

    (add-hook 'c++-mode-hook
              (lambda ()
                (eglot-ensure)
                (message "called c++-mode-hook")
                (setq c-default-style "bsd")
                (setq c-basic-offset 2)         ; basic indent value
                (setq tab-width 2)              ; tab width
                (setq indent-tabs-mode nil)     ; indent use space.
                (c-set-offset 'innamespace 0)   ; namespace indent pos is 0
                ))
    (add-hook 'c-mode-hook
              (lambda ()
                (eglot-ensure)
                (message "called c-mode-hook")
                (setq c-default-style "bsd")
                (setq c-basic-offset 2)         ; basic indent value
                (setq tab-width 2)              ; tab width
                (setq indent-tabs-mode nil)     ; indent use space.
                (c-set-offset 'innamespace 0)   ; namespace indent pos is 0
                ))
    (add-hook 'java-mode-hook
              (lambda ()
                (eglot-ensure)
                (message "called java-mode-hook")
                )))
#+end_src

*** consult-eglot
consultとeglotを統合するパッケージ。シンボルの検索が行えるようになる。
[[https://github.com/mohkale/consult-eglot]]
#+begin_src emacs-lisp
  (use-package consult-eglot
    :ensure t
    :after eglot
    :bind
    ("C-c s" . consult-eglot-symbols))
#+end_src

*** jsonrpc
jsonを扱うEmacsの標準パッケージ
標準パッケージなのでensure nilして、パッケージを取得しないようにしている
デフォルトのタイムアウト時間が短いため、タイムアウトしないように時間を延ばしている
また、ログを無視するように設定し、パフォーマンスを向上させている。
#+begin_src emacs-lisp
  (use-package jsonrpc
    :ensure nil
    :config
    (setq jsonrpc-default-request-timeout 3000)
    (fset #'jsonrpc--log-event #'ignore))
#+end_src

*** eglot-x
eglotでサポートされる機能が増える
#+begin_src emacs-lisp
  (use-package eglot-x
    :ensure t
    :vc ( :fetcher github :repo "nemethf/eglot-x")
    :after eglot
    :config
    (eglot-x-setup))

#+end_src

*** eldoc-box
ミニバッファのeldocをposframeで表示してくれる
#+begin_src emacs-lisp
  (use-package eldoc-box
    :ensure t
    :defer 1
    :hook (eglot-managed-mode . eldoc-box-hover-mode))
#+end_src

*** eglot-signature-eldoc-talkative
eldocの情報を追加する
#+begin_src emacs-lisp
  (use-package eglot-signature-eldoc-talkative
    :ensure t
    :after eldoc-box
    :config
    (advice-add #'eglot-signature-eldoc-function
                :override #'eglot-signature-eldoc-talkative))
#+end_src

** dap
*** dape
lldb-dapを用いてデバッグを行う
#+begin_src emacs-lisp
  ;; dape
  (use-package dape
    :ensure t
    :defer 1
    :bind-keymap
    ("C-x C-a" . dape-global-map)
    :config
    ;; Global bindings for setting breakpoints with mouse
    (dape-breakpoint-global-mode)
    ;; Showing inlay hints
    (setq dape-inlay-hints t)
    ;; Pulse source line (performance hit)
    (add-hook 'dape-display-source-hook 'pulse-momentary-highlight-one-line))
#+end_src

*** cmake-build
自作パッケージ  
emacsからCMakeを用いたビルドをサポートするツール  
#+begin_src emacs-lisp
  (use-package cmake-build
    :vc (:fetcher github :repo IwachanOrigin/cmake-build)
    :defer 1)
#+end_src

*** dape-cmake
自作パッケージ  
ビルドした実行ファイルをdapeで比較的簡単にデバッグ実行できるようにするツール  
#+begin_src emacs-lisp
(use-package dape-cmake
    :vc (:fetcher github :repo IwachanOrigin/dape-cmake))
#+end_src

*** repeat
dape-modeを使う場合、repeat-modeを有効にするとエルゴノミクス的な視点で便利  
dapeはデフォルトでC-x C-a を起点としてステップイン・ステップオーバーなどを定義している  
repeat-modeを使えば、C-x C-a n を何度も実行しなくても n だけで進めることが出来る  
#+begin_src emacs-lisp
  (use-package repeat
    :ensure t
    :after dape
    :config
    (repeat-mode))
#+end_src

** rst
#+begin_src emacs-lisp
  (use-package rst
    :defer 2
    :load-path "~/.emacs.d/external/rst"
    :config
    (add-to-list 'auto-mode-alist '("\.rst$" . rst-mode))
    (add-to-list 'auto-mode-alist '("\.rest$" . rst-mode))
    (setq frame-background-mode 'dark)
    (add-hook 'rst-mode-hook #'(lambda() (setq indent-tabs-mode nil))))
#+end_src

** hlsl-mode.el
#+begin_src emacs-lisp
  (use-package hlsl-mode
    :defer 5
    :load-path "~/.emacs.d/external/hlsl"
    :config
    (add-to-list 'auto-mode-alist '("\.fx$" . hlsl-mode))
    (add-to-list 'auto-mode-alist '("\.fxh$" . hlsl-mode))
    (add-to-list 'auto-mode-alist '("\.hlsl$" . hlsl-mode))
    (setq frame-background-mode 'dark)
    (add-hook 'hlsl-mode-hook #'(lambda() (setq indent-tabs-mode nil))))
#+end_src
** yaml
#+begin_src emacs-lisp
  (use-package yaml-mode
    :ensure t
    :mode ("\\.ya?ml\\'" . yaml-mode)
    :config (setq yaml-indent-offset 2))
#+end_src

** flymake
#+begin_src emacs-lisp
(use-package flymake
  :ensure nil
  :hook
  (prog-mode . flymake-mode)
  ((flymake-diagnostics-buffer-mode
    flymake-project-diagnostics-mode)
   . (lambda ()
       (when (display-graphic-p)
         (ignore-errors (text-scale-decrease 1)))))
  :custom
  (flymake-indicator-type 'margins)

  :bind
  (:map flymake-mode-map
        ("<left-fringe> <mouse-1>" . nil))

  :config
  ;; メニューに「Project全体の診断」を追加
  (keymap-set-after (default-value 'flymake-menu) "<list-project-problems>"
    '(menu-item "List all Project Problems" flymake-show-project-diagnostics)
    'List\ all\ problems)

  ;; Flymake一覧の「行/列」カラムを少し広げる
  (when (boundp 'flymake--diagnostics-base-tabulated-list-format)
    (setf (cadr (aref flymake--diagnostics-base-tabulated-list-format 2)) 10))

  ;; whitespace 等と併用して margin が詰まる場合の保険
  (advice-add #'flymake--indicator-overlay-spec
              :filter-return
              (lambda (indicator)
                (concat indicator
                        (propertize " " 'face 'default
                                    'display `((margin left-margin)
                                               (space :width 1))))))

  ;; nerd-icons がロードされてから設定
  (with-eval-after-load 'nerd-icons
    (when (fboundp 'nerd-icons-faicon) ; 念のため
      (setopt flymake-margin-indicators-string
              `((error   ,(nerd-icons-faicon "nf-fa-remove_sign") compilation-error)
                (warning ,(nerd-icons-faicon "nf-fa-warning")     compilation-warning)
                (note    ,(nerd-icons-faicon "nf-fa-circle_info") compilation-info))))))
#+end_src

** hl-todo
#+begin_src emacs-lisp
  (use-package hl-todo
    :ensure t
    :hook ((prog-mode text-mode) . hl-todo-mode)
    :custom
    (hl-todo-require-punctuation t)
    (hl-todo-highlight-punctuation ":")
    :config
    ;; TODOコメントを Flymake の診断として出す
    (add-hook 'flymake-diagnostic-functions #'hl-todo-flymake)

    ;; 色分け
    (let ((err (face-attribute 'error   :foreground))
          (wrn (face-attribute 'warning :foreground))
          (inf (face-attribute 'success :foreground))
          ;; nerd-icons-blue が無い環境でも落ちないように保険
          (msc (or (ignore-errors (face-attribute 'nerd-icons-blue :foreground))
                   (face-attribute 'link :foreground))))
      (dolist (k '("BUG" "DEFECT" "ISSUE" "FAIL" "FIXME"))
        (add-to-list 'hl-todo-keyword-faces `(,k . ,err)))
      (dolist (k '("WARNING"))
        (add-to-list 'hl-todo-keyword-faces `(,k . ,wrn)))
      (dolist (k '("WORKAROUND" "NOTE" "TRICK" "HACK"))
        (add-to-list 'hl-todo-keyword-faces `(,k . ,inf)))
      (dolist (k '("TODO" "DEBUG" "STUB"))
        (add-to-list 'hl-todo-keyword-faces `(,k . ,msc)))))
#+end_src

* Custom functions
** pandocを利用して、マークダウンからスライドを生成する関数
pandoc, latex, elsvogel.latexを導入する必要がある
[[https://github.com/enhuiz/eisvogel][eisvogel.latex]]
#+begin_src emacs-lisp
  (defun pandoc-markdown-slides-pdf ()
    "create beamer slides from pandoc, latex."
    (interactive)
    (setq infilename (buffer-file-name))
    (setq outfilename (replace-regexp-in-string ".md" ".pdf" infilename))
    (when (eq system-type 'windows-nt)
      (setq cmd-str (concat "pandoc.exe " infilename " -o " outfilename " --from markdown --to beamer --template eisvogel.latex --listings --pdf-engine \"xelatex\" -V CJKmainfont=\"Meiryo UI\"")))
    (unless (eq system-type 'windows-nt)
      (setq cmd-str (concat "pandoc " infilename " -o " outfilename " --from markdown --to beamer --template eisvogel.latex --listings --pdf-engine \"xelatex\" -V CJKmainfont=\"Noto Sans CJK JP\"")))
    (shell-command-to-string cmd-str))
  (global-set-key (kbd "C-x C-l") 'pandoc-markdown-slides-pdf)
#+end_src

** pandocを利用して、現在のバッファをPDFにして保存する関数
#+begin_src emacs-lisp
  (defun pandoc-buffer-pdf ()
    "create buffer to pdf."
    (interactive)
    (let* ((buffer-content (buffer-string))
           (tempfile (make-temp-file "pandoc-buffer" nil ".md"))
           (outfilename (concat (file-name-sans-extension tempfile) ".pdf"))
           (cmd-str (if (eq system-type 'windows-nt)
                        (format "pandoc.exe \"%s\" -o \"%s\" --pdf-engine=xelatex -V documentclass=bxjsarticle -V classoption=pandoc" tempfile outfilename)
                      (format "pandoc.exe \"%s\" -o \"%s\" --pdf-engine=xelatex -V documentclass=bxjsarticle -V classoption=pandoc" tempfile outfilename))))
      (with-temp-file tempfile
        (insert buffer-content))
      (shell-command-to-string cmd-str)
      (message "PDF created: %s" outfilename)))
#+end_src

** プライマリモニターの解像度の70%に設定し、emacsのウィンドウを中央に配置する関数
#+begin_src emacs-lisp
  (defun my-setup-frame-size-and-position ()
    "プライマリモニターの解像度の70%に設定し、中央に配置します。"
    (let* ((monitor-attrs (car (display-monitor-attributes-list)))  ; プライマリモニターの情報を取得
           (geometry (alist-get 'geometry monitor-attrs))           ; モニターのジオメトリ（位置とサイズ）
           (screen-width (nth 2 geometry))                          ; ディスプレイの幅（ピクセル）
           (screen-height (nth 3 geometry))                         ; ディスプレイの高さ（ピクセル）
           (char-width (frame-char-width))                          ; 1文字の幅（ピクセル）
           (char-height (frame-char-height))                        ; 1文字の高さ（ピクセル）
           (frame-width (round (/ (* 0.7 screen-width) char-width))) ; フレーム幅（文字単位）
           (frame-height (round (/ (* 0.7 screen-height) char-height))) ; フレーム高さ（文字単位）
           (frame-left (round (/ (- screen-width (* frame-width char-width)) 2))) ; 左端位置
           (frame-top (round (/ (- screen-height (* frame-height char-height)) 2)))) ; 上端位置
      ;; default-frame-alistに設定を追加
      (add-to-list 'default-frame-alist `(width . ,frame-width))
      (add-to-list 'default-frame-alist `(height . ,frame-height))
      (add-to-list 'default-frame-alist `(left . ,frame-left))
      (add-to-list 'default-frame-alist `(top . ,frame-top))))

  ;; Adjusted config when run emacs
  (my-setup-frame-size-and-position)
#+end_src

* Enhance C-s settings
** migemo
This package can use the Roman alphabet to search  the japanese language.  
We need to install cmigemo for Windows [migemo-kaoriya-64](https://www.kaoriya.net/software/cmigemo/)  
Please add path cmigemo.exe.  
#+begin_src emacs-lisp
  (use-package migemo
    :ensure t
    :defer 1
    :config
    ;; use to C/Migemo
    (setq migemo-command "cmigemo")
    (setq migemo-options '("-q" "--emacs" "-i" "\a"))
    ;; The following description is the art of treating relative paths as absolute paths
    ;; (expand-file-name "~/.emacs.d/init.el")
    ;; dictionary path and charset encoding
    (when IS-WINDOWS
      (setq migemo-dictionary (expand-file-name "~/.emacs.d/cmigemo-default-win64/dict/cp932/migemo-dict"))
      (setq migemo-coding-system 'cp932-unix))
    (unless IS-WINDOWS
      (setq migemo-dictionary (expand-file-name "~/.emacs.d/cmigemo-default-win64/dict/utf-8/migemo-dict"))
      (setq migemo-coding-system 'utf-8-unix))
    (setq migemo-user-dictionary nil)
    (setq migemo-regex-dictionary nil)

    :config
    (migemo-init))
#+end_src

** Hydra config
*** helper func to hydra menu
#+begin_src emacs-lisp
  (defun my/hydra-disable-dimmer ()
    (when (bound-and-true-p dimmer-mode)
      (dimmer-mode -1)))

  (defun my/hydra-enable-dimmer ()
    (unless (bound-and-true-p dimmer-mode)
      (dimmer-mode 1)))
#+end_src

*** hydra
#+begin_src emacs-lisp
  (use-package hydra
    :ensure t
    :defer 2
    :bind ("C-c SPC" . hydra-shortcut-of-emacs/body))

      ;; shortcut key map of emacs
  (defhydra hydra-shortcut-of-emacs (:hint nil
                                           :pre (my/hydra-disable-dimmer)
                                           :post (my/hydra-enable-dimmer))
    "
  ^
  ^shortcut-of-emacs(M-C は C-Mと同じ)
  ^
  ^Move^                            ^Select^                              ^Others^
  ^-----------------------------------------------------------------------------------------------
  _M-<_: バッファの先頭へ移動    _C-x h_: 全選択                      _M-x replace-string_: 文字列置換
  _M->_: バッファの末尾へ移動    _C-x SPC_: C-o > 空白挿入            _C-x r_: emacs restart
  _M-f_: 次の単語へ移動                : C-t 文字列 > 文字列置換     _M-x sort-lines_: 選択領域の並び替え
  _M-b_: 前の単語へ移動         _M-k_: 行を切り取り                   _M-<f10>_: fullscreen/default
  _M-C-a_: 関数定義の先頭へ移動  _M-SPC_: 連続スペースを1つにまとめる   _C-x x t_: toggle-truncate-lines
  _M-C-e_: 関数定義の末尾へ移動  _M-C-h_: 関数単位で選択               _C-c n_: flymake next error
  _M-C-n_: 次の括弧終わりへ移動  _C-x C-r_: Recentfの起動             _C-c p_: flymake prev error
  _M-C-p_: 前の括弧始まりへ移動                                       _C-x C-n_: dired-sidebar-toggle-sidebar
                                                               _C-x C-l_: pandoc-markdown-pdf
                                                               _C-c h_: toggle-display-fill-column-indicator-mode
  "
    ;; Move
    ("M-<" beginning-of-buffer)
    ("M->" end-of-buffer)
    ("M-f" forward-word)
    ("M-b" backward-word)
    ("M-C-a" c-beginning-of-defun)
    ("M-C-e" c-end-of-defun)
    ("M-C-n" forward-list)
    ("M-C-p" backward-list)
    ;; Select
    ("C-x h" mark-whole-buffer)
    ("C-x SPC" rectangle-mark-mode)
    ("M-k" kill-sentence)
    ("M-SPC" just-one-space)
    ("M-C-h" c-mark-function)
    ("C-x C-r" recentf-open-files)
    ;; Others
    ("M-x replace-string" replace-string)
    ("C-x r" restart-emacs)
    ("M-x sort-lines" sort-lines)
    ("M-<f10>" toggle-frame-maximized)
    ("C-x x t" toggle-truncate-lines)
    ("C-c n" flymake-goto-next-error)
    ("C-c p" flymake-goto-prev-error)
    ("C-x C-n" dired-sidebar-toggle-sidebar)
    ("C-x C-l" pandoc-markdown-pdf)
    ("C-c h" toggle-display-fill-column-indicator-mode))
#+end_src

* server configuration for emacsclient
** server
#+begin_src emacs-lisp
    (when (eq system-type 'windows-nt)
      (use-package server
        :ensure nil
        :defer 0.01
        :config
        (unless (server-running-p)
          (server-start))
        ;; Assign kill buffer to C-x C-c
        ;; NOTE : Until 29.4 I used [kill-this-buffer], but since 30.1 I can't turn off the buffer except via the menu.
        ;; To solve this problem, [kill-current-buffer] is used.
        ;; It was mentioned as a bug, but it was closed after the description to use [kill-current-buffer] was written in the document.
        ;; https://emacs.stackexchange.com/a/55047
        ;; https://lists.gnu.org/archive/html/bug-gnu-emacs/2024-06/msg00840.html
        (global-set-key (kbd "C-x C-c") #'kill-current-buffer)
        ;; Allow Emacs to exit with M-x exit
        (defalias 'exit 'save-buffers-kill-emacs)
        ;; yes/no query on exit
        (setq confirm-kill-emacs 'yes-or-no-p)))
#+end_src

** restart-emacs
Windows11 ではrestart-emacsがうまく動作しない場合がある  
プロセスは終了するが、立ち上がってこない  
理由は不明だが、runemacs.exeの起動時引数に"--debug-init"や"-Q"などを指定するとうまく再起動が出来る  
何か引数が無いとダメなようだ。30.1でこの現象は再現済み  
#+begin_src emacs-lisp
  (when (>= emacs-major-version 29)
    (global-set-key (kbd "C-x r") #'restart-emacs))
#+end_src

* org
** org-mode
org本体
ensure nilしてパッケージをmelpaなどから取得しないようにした
#+begin_src emacs-lisp
  (use-package org
    :ensure nil
    :defer 1
    :init
    (setq org-return-follows-link t) ; Returnキーでリンク先を開く
    (setq org-mouse-1-follows-link t) ; マウスクリックでリンク先を開く
    (setq org-log-done 'time) ; org-logを有効化し、タスクのステータスが変わった時間を記録する
    (setq org-log-into-drawer t) ; org-logの記録をドロワーで隠す
    ;; Learn about the ! and more by reading the relevant section of the
    ;; Org manual. Evaluate: (info "(org) Tracking TODO state changes")
    (setq org-todo-keywords
          '((sequence "TODO(t)" "WAIT(w!)" "|" "CANCEL(c!)" "DONE(d!)"))))

  ;;  アンダースコアを入力しても下付き文字にならないようにする
  (setq org-use-sub-superscripts '{}
        org-export-with-sub-superscripts nil)
#+end_src

** org-indent
たぶん、orgに含まれている
#+begin_src emacs-lisp
  (use-package org-indent
    :ensure nil
    :hook (org-mode . org-indent-mode)
    :after org)
#+end_src

** org-modern
#+begin_src emacs-lisp
  (use-package org-modern
    :ensure t
    :after org
    :custom
    (org-modern-star
     '(" " "󰎥 " "󰎨 " "󰎫" "󰎲 " "󰎯 " "󰎴 " "󰎷 " "󰎺 " "󰎽 " "󰏀 "))
    :config
    (setopt
     ;; Edit settings
     org-auto-align-tags nil
     org-tags-column 0
     org-catch-invisible-edits 'show-and-error
     org-special-ctrl-a/e t
     org-insert-heading-respect-content t

     ;; Org styling, hide markup etc.
     org-hide-emphasis-markers t
     org-pretty-entities t

     ;; Agenda styling
     org-agenda-tags-column 0
     org-agenda-block-separator ?─
     org-agenda-time-grid
     '((daily today require-timed)
       (800 1000 1200 1400 1600 1800 2000)
       " ┄┄┄┄┄ " "┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄")
     org-agenda-current-time-string
     "◀── now ─────────────────────────────────────────────────")

    ;; Ellipsis styling
    (setopt org-ellipsis "…")
    (set-face-attribute 'org-ellipsis nil :inherit 'default :box nil)

    ;; Choose some fonts
    (set-face-attribute 'default nil :family "Iosevka NF")
    (set-face-attribute 'variable-pitch nil :family "Iosevka NFP")
    (set-face-attribute 'org-modern-symbol nil :family "Iosevka NF")

    ;; Add frame borders and window dividers
    (modify-all-frames-parameters
     '((right-divider-width . 40)
       (internal-border-width . 40)))
    (dolist (face '(window-divider
                    window-divider-first-pixel
                    window-divider-last-pixel))
      (face-spec-reset-face face)
      (set-face-foreground face (face-attribute 'default :background)))
    (set-face-background 'fringe (face-attribute 'default :background))

    (global-org-modern-mode))
#+end_src

** org-modern-indent
#+begin_src emacs-lisp
  (use-package org-modern-indent
    :ensure t
    :vc ( :fetcher github :repo "jdtsmith/org-modern-indent")
    :after org-modern
    :config
    (add-hook 'org-mode-hook #'org-modern-indent-mode 90))
#+end_src

* Others
** keycast
[[https://github.com/tarsius/keycast]]
[[https://protesilaos.com/emacs/dotemacs]]
5.3.1. The prot-emacs-modeline.el section about keycast
#+begin_src emacs-lisp
  (use-package keycast
    :ensure t
    :defer 1
    :commands (keycast-mode-line-mode keycast-header-line-mode keycast-tab-bar-mode keycast-log-mode)
    :init
    (setq keycast-mode-line-format "%2s%k%c%R")
    (setq keycast-mode-line-window-predicate 'mode-line-window-selected-p)
    (setq keycast-mode-line-remove-tail-elements nil)
    (keycast-mode-line-mode)
    :config
    (dolist (input '(self-insert-command org-self-insert-command))
      (add-to-list 'keycast-substitute-alist `(,input "." "Typing…")))

    (dolist (event '( mouse-event-p mouse-movement-p mwheel-scroll handle-select-window
                      mouse-set-point mouse-drag-region))
      (add-to-list 'keycast-substitute-alist `(,event nil))))
#+end_src

** time(Display current time)
モードラインに現在の時間を表示する
[[https://github.com/emacs-mirror/emacs/blob/master/lisp/time.el]]
[[https://protesilaos.com/emacs/dotemacs]]
5.2.16. The prot-emacs-essentials.el configurations for the date and time (display-time-mode)
#+begin_src emacs-lisp
  (use-package time
    :ensure nil
    :hook (after-init . display-time-mode)
    :config
    (setq display-time-format " %a %e %b, %H:%M ")
    ;;;; Covered by `display-time-format'
    ;; (setq display-time-24hr-format t)
    ;; (setq display-time-day-and-date t)
    (setq display-time-interval 60)
    (setq display-time-default-load-average nil)
    ;; NOTE 2022-09-21: For all those, I have implemented my own solution
    ;; that also shows the number of new items, although it depends on
    ;; notmuch: the `notmuch-indicator' package.
    (setq display-time-mail-directory nil)
    (setq display-time-mail-function nil)
    (setq display-time-use-mail-icon nil)
    (setq display-time-mail-string nil)
    (setq display-time-mail-face nil)

    ;; I don't need the load average and the mail indicator, so let this
    ;; be simple:
    (setq display-time-string-forms
          '((propertize
             (format-time-string display-time-format now)
             'face 'display-time-date-and-time
             'help-echo (format-time-string "%a %b %e, %Y" now))
            " ")))
#+end_src

** 画面の100文字目あたりに線を出す設定
#+begin_src emacs-lisp
  (setq-default display-fill-column-indicator-column 100)
  (global-display-fill-column-indicator-mode)
#+end_src

** bufferlistのひとつ前 or 次 へ移動するキーバインド
現在のバッファからひとつ前、ひとつ後へ移動する
#+begin_src emacs-lisp
(global-set-key (kbd "M-[") 'switch-to-prev-buffer)
(global-set-key (kbd "M-]") 'switch-to-next-buffer)
#+end_src

** org to markdown出力時、titleがあったら「# title」を追加する関数
#+begin_src emacs-lisp
  (with-eval-after-load 'ox-md
    ;; org-md-template (CONTENTS INFO) の返り値冒頭にタイトルを挿入
    (defun my/org-md-template-prepend-title (orig-fun contents info)
      (let* ((res   (funcall orig-fun contents info))
             ;; Org 側にタイトルがあれば取得
             (raw-title (plist-get info :title))
             ;; Org の書式（句読点やマクロ等）を展開
             (title (and raw-title (org-export-data raw-title info))))
        (if (and title (plist-get info :with-title))
            (concat "# " title "\n\n" res)
          res)))
    (advice-add 'org-md-template :around #'my/org-md-template-prepend-title))
#+end_src

** recentfでネットワークアクセスパスは存在確認から除外する
NW上のファイルがrecentfにある場合、ファイルの存在チェックなどが自動で走り、環境によってはUIが固まるのでその対策
#+begin_src emacs-lisp
  (with-eval-after-load 'recentf
    (add-to-list 'recentf-exclude "^//[^/]+/"))
#+end_src
** Output custom setting to custom.el.
#+begin_src emacs-lisp
  ;; i.e. (custom-set-variables~~~ (custom-set-faces~~~~
  (setq custom-file (concat user-emacs-directory "custom.el"))
  (load custom-file t)
#+end_src

** footer
#+begin_src emacs-lisp
  ;;(profiler-report)
  ;;(profiler-stop)

  (provide 'init)
#+end_src
